---
title: "Suppl Figure 3"
output: html_document
date: "2024-09-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ggplot2)
library(dplyr)
library(colorspace)  # For adjusting color brightness
library(scales)      # For brewer_pal function
library(gridExtra)   # For arranging plots
library(tidyverse)

memory_data <- read.csv("/home/czackl/spacedeconv-paper/subset2/results/memory_usage.csv")

# Convert memory from kilobytes (K) to gigabytes (GB)
memory_data$MaxBatchMemory <- as.numeric(gsub("K", "", memory_data$MaxBatchMemory)) / (1024^2)

memory_data$Scenario <- factor(memory_data$Scenario, levels = c("Orig", "Mirror", "Even"))

execution_data <- read.csv("/home/czackl/spacedeconv-paper/subset2/results/execution_time.csv")

# Step 5: Convert time strings to seconds for execution time data
convert_to_seconds <- function(time_str) {
  if (is.na(time_str) || time_str == "") {
    return(NA)  # Return NA for empty or missing time strings
  } else {
    tryCatch({
      period_to_seconds(hms(time_str))  # Convert to seconds
    }, error = function(e) {
      return(NA)  # If there's any error, return NA
    })
  }
}

execution_data$TimeSignatureSeconds <- sapply(execution_data$Time.Signature, convert_to_seconds)
execution_data$TimeDeconvSeconds <- sapply(execution_data$TimeDeconv, convert_to_seconds)

# Ensure 'Scenario' is a factor and reorder it with 'Orig' on the left
execution_data$Scenario <- factor(execution_data$Scenario, levels = c("Orig", "Mirror", "Even"))

# Step 6: Prepare data for plotting speedup and memory efficiency

# Signature Speedup
signature_speedup <- execution_data %>%
  filter(!is.na(TimeSignatureSeconds)) %>%
  group_by(Method, Scenario) %>%
  summarise(mean_signature_time = mean(TimeSignatureSeconds, na.rm = TRUE)) %>%
  pivot_wider(names_from = Scenario, values_from = mean_signature_time) %>%
  mutate(
    MirrorSpeedupSignature = Orig / Mirror,
    EvenSpeedupSignature = Orig / Even
  )

# Deconvolution Speedup
deconv_speedup <- execution_data %>%
  filter(!is.na(TimeDeconvSeconds)) %>%
  group_by(Method, Scenario) %>%
  summarise(mean_deconv_time = mean(TimeDeconvSeconds, na.rm = TRUE)) %>%
  pivot_wider(names_from = Scenario, values_from = mean_deconv_time) %>%
  mutate(
    MirrorSpeedupDeconv = Orig / Mirror,
    EvenSpeedupDeconv = Orig / Even
  )

# Memory Efficiency
memory_efficiency <- memory_data %>%
  group_by(Method, Scenario) %>%
  summarise(mean_memory = mean(MaxBatchMemory, na.rm = TRUE)) %>%
  pivot_wider(names_from = Scenario, values_from = mean_memory) %>%
  mutate(
    MirrorMemoryEfficiency = Orig / Mirror,
    EvenMemoryEfficiency = Orig / Even
  )

# Step 7: Prepare the data for plotting by reshaping it for easier boxplot creation

# Signature Speedup
signature_speedup_melted <- signature_speedup %>%
  select(Method, MirrorSpeedupSignature, EvenSpeedupSignature) %>%
  tidyr::pivot_longer(cols = -Method, names_to = "Scenario", values_to = "Speedup") %>%
  mutate(Scenario = factor(Scenario, labels = c("Mirror", "Even")))

# Deconvolution Speedup
deconv_speedup_melted <- deconv_speedup %>%
  select(Method, MirrorSpeedupDeconv, EvenSpeedupDeconv) %>%
  tidyr::pivot_longer(cols = -Method, names_to = "Scenario", values_to = "Speedup") %>%
  mutate(Scenario = factor(Scenario, labels = c("Mirror", "Even")))

# Memory Efficiency
memory_efficiency_melted <- memory_efficiency %>%
  select(Method, MirrorMemoryEfficiency, EvenMemoryEfficiency) %>%
  tidyr::pivot_longer(cols = -Method, names_to = "Scenario", values_to = "Efficiency") %>%
  mutate(Scenario = factor(Scenario, labels = c("Mirror", "Even")))

# Step 8: Create boxplots for Signature Speedup, Deconvolution Speedup, and Memory Efficiency

# Cut off the first color of the palette and use the second and third colors for two-category plots
two_color_palette <- RColorBrewer::brewer.pal(3, "Set3")[2:3]
three_color_palette <- RColorBrewer::brewer.pal(3, "Set3")
border_colors_two <- darken(two_color_palette, amount = 0.2)
border_colors_three <- darken(three_color_palette, amount = 0.2)

# Manually set method names
method_labels <- c("CARD", "cell2location", "RCTD", "spatialDWLS", "SPOTlight")

# Signature Speedup Boxplot
signature_speedup_boxplot <- ggplot(signature_speedup_melted, aes(x = Method, y = Speedup, fill = Scenario)) +
  geom_boxplot(aes(color = Scenario), size = 0.5) +
  geom_hline(yintercept = 1, linetype = "solid", color = "gray") +  # Add a horizontal line at y = 1
  theme_minimal() +
  labs(x = "Method", y = "Signature Speedup (log10)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), axis.title.x = element_blank()) +
  scale_x_discrete(labels = method_labels) +
  scale_fill_manual(values = two_color_palette) +
  scale_color_manual(values = border_colors_two) + 
  scale_y_log10()

# Deconvolution Speedup Boxplot
deconv_speedup_boxplot <- ggplot(deconv_speedup_melted, aes(x = Method, y = Speedup, fill = Scenario)) +
  geom_boxplot(aes(color = Scenario), size = 0.5) +
  geom_hline(yintercept = 1, linetype = "solid", color = "gray") +  # Add a horizontal line at y = 1
  theme_minimal() +
  labs(x = "Method", y = "Deconvolution Speedup (log10)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), axis.title.x = element_blank()) +
  scale_x_discrete(labels = method_labels) +
  scale_fill_manual(values = two_color_palette) +
  scale_color_manual(values = border_colors_two) + 
  scale_y_log10()

# Memory Efficiency Boxplot
memory_efficiency_boxplot <- ggplot(memory_efficiency_melted, aes(x = Method, y = Efficiency, fill = Scenario)) +
  geom_boxplot(aes(color = Scenario), size = 0.5) +
  geom_hline(yintercept = 1, linetype = "solid", color = "gray") +  # Add a horizontal line at y = 1
  theme_minimal() +
  labs(x = "Method", y = "Memory Efficiency (log10)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), axis.title.x = element_blank()) +
  scale_x_discrete(labels = method_labels) +
  scale_fill_manual(values = two_color_palette) +
  scale_color_manual(values = border_colors_two)  +
  scale_y_log10()

# Step 9: Create boxplots for Memory Usage, Signature Time, and Deconvolution Time

# Memory Usage Boxplot
memory_boxplot <- ggplot(memory_data, aes(x = Method, y = MaxBatchMemory, fill = Scenario)) +
  geom_boxplot(aes(color = Scenario), size = 0.5) +
  theme_minimal() +
  labs(x = "Method", y = "Max Memory Usage (GB, log10)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), axis.title.x = element_blank()) +
  scale_x_discrete(labels = method_labels) +
  scale_fill_manual(values = three_color_palette) +
  scale_color_manual(values = border_colors_three) + 
  scale_y_log10()

# Filter out "RCTD" and "CARD" from execution_data
execution_data_filtered <- execution_data %>%
  filter(!Method %in% c("RCTD", "CARD"))

# Signature Time Boxplot without "RCTD" and "CARD"
signature_boxplot <- ggplot(execution_data_filtered, aes(x = Method, y = TimeSignatureSeconds / 60, fill = Scenario)) +  # Convert to minutes
  geom_boxplot(aes(color = Scenario), size = 0.5) +
  theme_minimal() +
  labs(x = "Method", y = "Signature Time (minutes, log10)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), axis.title.x = element_blank()) +
  scale_x_discrete(labels = method_labels[!(method_labels %in% c("CARD", "RCTD"))]) +  # Remove "RCTD" and "CARD" from labels
  scale_fill_manual(values = three_color_palette) +
  scale_color_manual(values = border_colors_three) + 
  scale_y_log10()

deconv_boxplot <- ggplot(execution_data, aes(x = Method, y = TimeDeconvSeconds / 60, fill = Scenario)) +  # Convert to minutes
  geom_boxplot(aes(color = Scenario), size = 0.5) +
  theme_minimal() +
  labs(x = "Method", y = "Deconvolution Time (minutes, log10)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 10)) +  # Adjust y-axis title size here
  scale_x_discrete(labels = method_labels) +
  scale_fill_manual(values = three_color_palette) +
  scale_color_manual(values = border_colors_three) + 
  scale_y_log10()

# Step 10: Extract a single legend from one of the plots (three-category)
legend <- ggpubr::get_legend(
  memory_boxplot + 
  guides(fill = guide_legend(nrow = 1)) +
  theme(legend.position = "bottom", legend.title = element_blank(), legend.justification = "center")
)

memory_boxplot <- memory_boxplot + theme(legend.position = "None")
signature_boxplot <- signature_boxplot+ theme(legend.position = "None")
deconv_boxplot <- deconv_boxplot+ theme(legend.position = "None")
memory_efficiency_boxplot <- memory_efficiency_boxplot+ theme(legend.position = "None")
signature_speedup_boxplot <- signature_speedup_boxplot+ theme(legend.position = "None")
deconv_speedup_boxplot <- deconv_speedup_boxplot + theme(legend.position = "None")
```

```{r}
library(cowplot)
empty_plot <- plot_grid(NULL)

final_layout_with_labels <- plot_grid(
  plot_grid(
    memory_boxplot, memory_efficiency_boxplot, signature_boxplot, signature_speedup_boxplot, 
    deconv_boxplot, deconv_speedup_boxplot, 
    labels = c("A", "B", "C", "D", "E", "F"),   # Add labels
    label_size = 16,  # Adjust the label size
    ncol = 2,         # Arrange in 2 columns
    align = "v",      # Align vertically
    rel_heights = c(1, 1, 1)  # Allocate equal space for the plots
  ),
  plot_grid(legend, empty_plot, ncol = 1, rel_widths = c(0.7, 0.3)),  # Center the legend by using an empty plot to balance space
  ncol = 1,  # Arrange everything in one column (2 columns for plots, then 1 row for the legend)
  rel_heights = c(12, 1)  # Set relative height for plots and legend
)

# Save the plot with centered legend
ggsave(filename = "/home/czackl/export/subset2/plots/supplementary_figure_3.png", 
       plot = final_layout_with_labels, dpi = 300, width = 10, height = 12, bg="white")

```
